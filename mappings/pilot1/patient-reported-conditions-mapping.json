{
  "url": "https://aiccelerate.eu/fhir/mappings/patient-reported-conditions-mapping",
  "name": "patient-reported-conditions-mapping",
  "title": "Mapping of schema patient reported conditions to AIC-PatientReportedCondition profile resources",
  "source": [{
    "alias": "source",
    "url": "/StructureDefinition/ext-patient-reported-conditions"
  }],
  "context": {
    "prcConceptMap":  {
      "category": "concept-map",
      "url": "./patient-reported-conditions-concept-map.csv"
    }
  },
  "mapping": [
    {
      "expression": {
        "name": "result",
        "language": "application/fhir-template+json",
        "value": {
          "{{#ind}}": "{{utl:evaluateExpression(utl:indices(1, 50).select('v' & $this.toString()).mkString(' | ')).indicesWhere($this.exists() and $this).select($this.toString())}}",
          "{{*}}": {
            "resourceType": "Condition",
            "id": "{{utl:uuid()}}",
            "meta": {
              "profile": [
                "https://aiccelerate.eu/fhir/StructureDefinition/AIC-PatientReportedCondition"
              ]
            },
            "verificationStatus": "{{? utl:createFhirCodeableConcept('http://terminology.hl7.org/CodeSystem/condition-ver-status', 'unconfirmed', {})}}",
            "code": {
              "coding": [
                {
                  "system": "http://snomed.info/sct",
                  "code": "{{utl:getConcept(%prcConceptMap, %ind, 'target_code')}}",
                  "display": "{{utl:getConcept(%prcConceptMap, %ind, 'target_display')}}"
                }
              ]
            },
            "subject": {
              "reference": "Patient/{{pid}}"
            },
            "encounter": "{{? utl:createFhirReference('Encounter', encounterId)}}",
            "recordedDate": "{{? time}}",
            "asserter": "{{utl:createFhirReference('Patient', pid)}}"
          }
        }
      }
    }
  ]
}